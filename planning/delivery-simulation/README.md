# Delivery Simulation — Planning

**Назначение документа**
Сформировать полное и практичное ТЗ для симуляции OpenDelivery, чтобы модель отражала реальную работу доставки, платежей и рисков, а не «стерильную» систему. Документ фиксирует цели, сущности, состояния заказа, события, денежные потоки, метрики, параметры политики, сценарии экспериментов, подход к валидации и список ключевых проблем/рисков.

**Краткое резюме задачи**
Нужно спроектировать (не кодить) агентную модель + Monte Carlo симуляцию доставки еды, которая показывает, где система ломается при росте, какие риски платежки и чарджбеков критичны, как меняется экономика и операционная нагрузка, и как реагируют политики платформы. Итогом должны стать спецификация модели, псевдокод, план экспериментов и список данных/логов для MVP.

**Контекст системы (фиксированные допущения)**
- Клиент платит: еда 100% ресторану, доставка 100% курьеру, чаевые 100% курьеру, платформа берет $1 за заказ.
- Комиссия платежки показывается отдельно.
- Basic (бесплатно): платформа не расследует и не компенсирует, споры на стороне ресторана.
- Protection Plan (подписка): сбор доказательств, базовый антифрод-анализ, помощь по чарджбекам через страховую, компенсации платит страховая, не платформа.
- Open-source: открыта бизнес-логика распределения денег; закрыты антифрод-правила, ключи, персональные данные, админ-инструменты.

**Ограничения модели (этика и безопасность)**
- Не давать инструкций по обходу антифрода или совершению мошенничества.
- Допускается описание типов злоупотреблений только на уровне категорий инцидентов для защитного моделирования.

---

**1. Цели симуляции (что хотим узнать)**
- Где система ломается первой: чарджбеки, фрод, SLA, экономика, операционка.
- Как ведут себя риски при росте масштаба: 1 район → 1 город → несколько городов.
- Сколько «плохих событий» в день и какая реакция нужна при тарифах Basic и Protection.
- Как политика платформы влияет на риск платежки и на опыт пользователей.
- При каких параметрах модель становится неустойчивой: рост споров, дефицит курьеров, массовые задержки.

**2. Сущности и роли (агенты)**
Требуется описать типы агентов и их параметры поведения.

| Агент | Типы поведения | Ключевые параметры | Основные события/влияние |
| --- | --- | --- | --- |
| Клиент | нормальный; конфликтный; «friendly fraud»; злоумышленник | частота заказов; склонность к жалобам; терпимость к задержкам; вероятность чарджбека | отмены; спор; повторный заказ; ухудшение NPS |
| Курьер | нормальный; часто косячит; хитрит; злоумышленник | доступность; скорость; склонность к отменам; надежность | задержки; неверная доставка; исчезновение |
| Ресторан | быстрый; перегруженный; системно ошибается; халтурит | время приготовления; надежность; точность заказа | задержки; неверный заказ; отказ готовить |
| Платежка | правила; лимиты; риски блокировки | пороги dispute/refund; риск-скоры; холды | удержания средств; блокировки; чарджбеки |
| Платформа | логирование; блокировки; лимиты; эскалации | правила флагов; пороги банов; SLA на проверки | блокировки; флаги; оповещения |
| Страховая | правила валидности доказательств | требования к данным; лимиты выплат | одобрение/отказ компенсаций |

**3. Машина состояний заказа (обязательная)**
Полный жизненный цикл заказа, включая все ветки и исключения.

| Состояние | Описание | Инициатор | Тайм-ауты/условия перехода |
| --- | --- | --- | --- |
| created | заказ создан | клиент | переход к оплате |
| paid / authorized | оплата авторизована | платежка | отказ/3DS/ревью |
| accepted | ресторан принял | ресторан | тайм-аут принятия |
| prepared | заказ готов | ресторан | тайм-аут кухни |
| pickup | курьер забрал | курьер | тайм-аут на забор |
| enroute | в пути | курьер | SLA по доставке |
| delivered | доставлен | курьер/клиент | подтверждение вручения |
| completed | завершен | платформа | закрытие заказа |
| cancel | отмена | клиент/ресторан/курьер/платформа | причина и момент отмены |
| refund | возврат | платформа/ресторан/платежка | частичный/полный |
| dispute/chargeback | спор | клиент/платежка | фаза спора |
| re-delivery | повторная доставка | платформа/ресторан | условия перезапуска |
| timeout | просрочка | платформа | автоматическое действие |

**4. События и вероятности (то, что будем «монте-карлить»)**
События моделируются по этапам, с вероятностями и зависимостью от типа агента.

| Этап | Категории событий |
| --- | --- |
| До оплаты | фейковые аккаунты; множественные попытки; подозрительные устройства |
| Оплата | отказ; 3DS; холд; ревью; проблемы карты; возвраты |
| Ресторан | задержка; неверный заказ; не увидели заказ; отказ готовить |
| Курьер | не взял заказ; взял и отменил; задержка; «доставил не туда»; пропал |
| Клиент | не отвечает; неверный адрес; жалоба «не получил»; чарджбек |
| Платформа | автофлаги; блокировки; лимиты; ручные проверки |

**5. География и время**
- Гео-модель: районы, кластеры ресторанов, плотность заказов, зоны риска.
- Временные циклы: пики по времени суток, дни недели, сезонность.
- Travel time: скорость + шум на трафик, простая модель пробок.
- Распределение курьеров по районам и временным окнам.

**6. Денежные потоки и бухгалтерия**
Явно определить, кто и когда платит, что списывается, что может быть заморожено, и как это отражается публично.

| Событие | Денежный поток | Риск/особенности |
| --- | --- | --- |
| Авторизация | холд на карте клиента | риск отказа/3DS |
| Списание (capture) | клиент → платежка → ресторан/курьер | комиссия платежки отдельно |
| Возврат | ресторан/страховая → клиент | частичный/полный |
| Чарджбек | платежка списывает | риск блокировки аккаунта |
| Заморозка | платежка удерживает средства | влияет на UX и обязательства |

**7. Метрики результата (что считать)**
Экономика:
- Доход платформы = $1 × N заказов.
- Стоимость операций: логирование, инфраструктура, модерация, поддержка.
- Потери: refunds, disputes, fraud.

Риски платежки:
- dispute rate; refund rate; тренды по времени и районам.

Операционка:
- количество инцидентов, жалоб, флагов в день.
- ложные баны и пропуски (false positives/false negatives).

Качество сервиса:
- среднее время доставки; доля отмен; доля просрочек.
- прокси NPS: вероятность повторного заказа.

Справедливость:
- перекосы по районам, типам устройств, новичкам.

**8. Политики платформы как параметры**
- Лимиты для новых аккаунтов: число заказов, сумма, радиус.
- Правила блокировок: триггеры, пороги, эскалация.
- Доказательства: фото, гео-пин, таймстемпы, логи курьера.
- Что включено в Basic vs Protection.
- Коммуникация в UI: что показываем сторонам, что скрываем.

**9. Сценарии экспериментов**
- Базовый честный город.
- «Плохой район» с повышенной долей споров.
- Бум роста (резкий рост заказов).
- Дефицит курьеров.
- Один плохой ресторан, портящий статистику.
- Усиление контроля платежкой.
- Всплеск мультиаккаунтов (категорически, без деталей).

**10. Валидация и калибровка**
- Какие параметры можно взять из открытых источников.
- Какие параметры нужно собрать в пилоте (перечень логов и событий).
- Sanity checks: ожидаемые закономерности, которые должны проявиться.

**11. Артефакты, которые должен выдать «учёный-ChatGPT»**
- Спецификация модели (агенты, состояния, события, параметры).
- Псевдокод симулятора.
- План экспериментов + таблица метрик.
- Список данных/логов для MVP.
- Список рисков, которые симуляция не покрывает.

---

**Критические проблемы и риски проекта (ключевые «болевые точки»)**
1. Деньги = доверие, а не математика. Прозрачные правила не гарантируют, что стороны будут их принимать при отменах, спорах и задержках.
2. Чарджбеки — самая опасная зона. Платежка считает платформу ответственной, независимо от UI и правил.
3. Конфликт open-source и антифрода. Прозрачность повышает риск утечек паттернов защиты.
4. Курьеры не ангелы. Модель должна учитывать «плохих» и выгнанных из других платформ.
5. Рестораны будут давить на расширение ответственности платформы, размывая миссию.
6. Страховые не любят нестандартные модели и могут навязывать условия, ухудшающие UX.
7. Юридическое давление. Регуляторы оценивают фактическую роль платформы, а не декларации.
8. Риск «съезда миссии». Давление на монетизацию и скрытие комиссий будет постоянным.

---

**Требования к данным и логированию (минимум для MVP)**
- Идентификаторы заказа и участников; статусы и переходы; таймстемпы всех ключевых этапов.
- Метки причин отмен, возврата, спора.
- Гео-точки и трек курьера (агрегировано, без персональных данных).
- Метрики платежных событий: авторизация, capture, refund, dispute.
- Версии правил и политик платформы в момент события.

**Открытые вопросы для уточнения**
- Кто merchant of record и как это влияет на чарджбеки.
- Логика распределения ответственности между рестораном, курьером и страховой.
- Минимальный набор доказательств, который принимает страховая.
- Политика холдов/ревью у платежки и допустимые пороги.

---

**Готовый промпт для ChatGPT (если нужно делегировать работу «учёному»)**
```text
Ты — исследователь/аналитик симуляций для проекта OpenDelivery.
Задача: спроектировать (НЕ программировать) полную модель симуляции работы сервиса, чтобы потом сделать агентную симуляцию + Monte Carlo и оценить частоты событий, операционную нагрузку, риски платежки и экономику.

Контекст системы (фиксировано):
- Клиент платит: еда 100% ресторану, доставка 100% курьеру, чаевые 100% курьеру, платформа берет $1, комиссия платежки показывается отдельно.
- Basic (бесплатно): платформа НЕ расследует, НЕ компенсирует, НЕ ведет споры за ресторан; ответственность за споры на ресторане.
- Protection Plan (подписка): сбор доказательств, базовый антифрод-анализ, помощь по чарджбекам через страховую; компенсации платит страховая, не платформа.
- Open-source: открыта логика распределения денег; закрыты антифрод-правила, ключи, персональные данные, админ-инструменты.

ОГРАНИЧЕНИЕ:
- Не давай инструкций, как обходить антифрод или совершать мошенничество.
- Можно описывать категории инцидентов на уровне типов.

Что нужно выдать (структурировано):
1) Цели симуляции.
2) Полный список агентов и типов.
3) Машина состояний заказа.
4) Каталог событий по этапам.
5) Модель времени и географии.
6) Модель денег и учет комиссий.
7) Набор метрик.
8) Политики платформы как параметры.
9) План экспериментов.
10) План калибровки и валидации.
11) Артефакты: псевдокод, лог-поля, список ограничений.

Формат ответа:
- Разделы 1–11 в этом порядке.
- Таблицы и списки для пунктов 2–5 и 8–9.
- В конце: «Критические пробелы».

Начинай.
```
